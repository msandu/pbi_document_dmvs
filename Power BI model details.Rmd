---
title: "Power BI model details"
output: 
  html_document:
    toc: TRUE
    code_folding: hide
    toc_float:
      collapsed: FALSE
      smooth_scroll: TRUE
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(htmltools)
library(RDCOMClient)
library(dplyr)
library(magrittr)
library(data.table)
library(jsonlite)
library(DT)
library(shiny)
source('helpers.R')

dmv_queries <- fromJSON("queries/dmv.json")

# TODO: the port can be scanned from the localappdata folder
# and the initial catalog retrieved via a DMV query

con <- COMCreate("ADODB.Connection")

con[["ConnectionString"]] <- paste(
  "Provider=MSOLAP.8",
  "Integrated Security=SSPI",
  "Persist Security Info=True",
  "Data Source=localhost:59788",
  "Initial Catalog=6138de76-abee-480a-b0ed-4850117d5090",
  sep = ";")

con$Open()

```

## Initial bit

Similar to a data [dictionary structure](https://www.sciencedirect.com/topics/computer-science/data-dictionary).

### Tables

Starting with tables as they are the first thing that one sees when loading a PBIX file inside Power BI Desktop.

```{r}

tables <- get_dmv('TMSCHEMA_TABLES')

tables %>%
  mutate(
    'Local date table' = grepl('LocalDateTable[a-z0-9\\-\\_]+', Name)
  ) %>%
  filter(
    IsHidden == 'FALSE'
  ) %>%
  select(
    Name,
    'Refresh policy ID' = RefreshPolicyID,
    'Excluded from refresh' = ExcludeFromModelRefresh,
    `Local date table`
  ) %>%
  datatable(
    style = 'bootstrap',
    filter = 'top')

```

### Partitions {.tabset .tabset-fade}

The Partition object represents a partition in a table. It is a child of a Table object and multiple partitions may be combined to form a single table. The partitions in
a table define the data from external data sources that become available when the table is 
queried.

```{r}
partitions <- get_dmv('TMSCHEMA_PARTITIONS')
partition_types <- fromJSON('labels/partition_types.json')
partition_modes <- fromJSON('labels/partition_modes.json')

partitions %<>%
  left_join(
    tables,
    by = c('TableID' = 'ID')
  ) %>%
  left_join(
    partition_types,
    by = c('Type' = 'ID')
  ) %>%
  left_join(
    partition_modes,
    by = c('Mode' = 'ID')
  ) %>%
  filter(
    IsHidden == 'FALSE'
  )

```

#### Without queries

```{r}

partitions  %>%
  select(
    'Partition name' = Name.x,
    'Table name' = Name.y,
    Description,
    'Type' = 'Type.y',
    'Mode' = 'Type.y.y',
    'Range start' = RangeStart,
    'Range end' = RangeEnd
  ) %>%
  datatable(
    style = 'bootstrap',
    filter = 'top')

```

#### With queries

```{r}

partitions %>%
  select(
    'Partition name' = Name.x,
    'Table name' = Name.y,
    Description,
    'Type' = 'Type.y',
    'Mode' = 'Type.y.y',
    'Range start' = RangeStart,
    'Range end' = RangeEnd,
    'Query' = QueryDefinition
  ) %>%
  datatable(
    style = 'bootstrap',
    filter = 'top')

```

