---
title: "Power BI model details"
output: 
  html_document:
    toc: TRUE
    code_folding: hide
    toc_float:
      collapsed: FALSE
      smooth_scroll: TRUE

---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(htmltools)
library(htmlwidgets)
library(RDCOMClient)
library(dplyr)
library(magrittr)
library(data.table)
library(jsonlite)
library(DT)
library(bsselectR)
library(plotly)
library(visNetwork)
source('helpers.R')

dmv_queries <- fromJSON("queries/dmv.json")

# TODO: the port can be scanned from the localappdata folder
# and the initial catalog retrieved via a DMV query

con <- COMCreate("ADODB.Connection")

con[["ConnectionString"]] <- paste(
  "Provider=MSOLAP.8",
  "Integrated Security=SSPI",
  "Persist Security Info=True",
  "Data Source=localhost:65246",
  "Initial Catalog=5a55d141-6ebe-4577-80f0-e10a8a4b53cf",
  sep = ";")

con$Open()

```

## Initial bit

Similar to a data [dictionary structure](https://www.sciencedirect.com/topics/computer-science/data-dictionary).

### Tables {.tabset .tabset-fade}

#### List of tables
Starting with tables as they are the first thing that one sees when loading a PBIX file inside Power BI Desktop.

```{r}

tables <- get_dmv('TMSCHEMA_TABLES') %>%
  # mutate(
  #   'Local date table' = grepl('LocalDateTable[a-z0-9\\-\\_]+', Name)
  # ) %>%
  filter(
    IsHidden == 'FALSE'
  )

tables %>%
  select(
    Name,
    'Refresh policy ID' = RefreshPolicyID,
    'Excluded from refresh' = ExcludeFromModelRefresh,
    # `Local date table`
  ) %>%
  datatable(
    style = 'bootstrap4',
    filter = 'top',
    width = '775.25px'
  )

```

#### Samples

```{js}

function sampleSelectionUpdate(){

  var dropdown = document.getElementById('sample_dropdown');
  var pickedTable = dropdown.options[dropdown.selectedIndex].outerText;
  
  for (var i = 0; i<data.length; i++) {
    if (data[i].Name == pickedTable) {
        var dataSet = data[i].Content;
        var columns = data[i].columns;
    }
  }
  
  // Absolute cancer - can't figure a better way to target the created table tag inside the datatable node
  // as the elementId argument inside DT::datatable, sets the ID of the node, which is a div tag.
  if (document.getElementById('data_table_id') == null) {
    var table_element = $('#target_table')[0].childNodes[0].childNodes[1].childNodes[0].childNodes[0].childNodes[1].childNodes[0];
    table_element.setAttribute('id', 'data_table_id');
  }

  $('#data_table_id').DataTable().destroy();

  $('#data_table_id').DataTable( {
      data: dataSet,
      columns: columns,
      destroy: true
  } );

}


```

```{r}
# Need columns in this step to add them to samples
columns <- get_dmv('TMSCHEMA_COLUMNS')
columns$ID <- as.integer(columns$ID)
columns %<>%
  arrange(ID)

samples <- tables %>% 
  filter(Name != 'Measures table') %>%
  select(Name)

samples$Content <- lapply(samples$Name, get_sample)
samples$columns <- lapply(samples$Content, get_headers)

# load these in browser as json
df_to_js(samples)

dropdown_options <- sort(samples$Name)

htmltools::HTML(
  paste0(
  '<select id="sample_dropdown" onchange="sampleSelectionUpdate();">
    <option>'
    ,paste(dropdown_options, collapse = '</option>
    <option>'),
    '</option>
  </select>
  <br>
  <br>'
  )
)

DT::datatable(data = NULL, elementId  = 'target_table')

# DT::datatable(
#   data = samples[[2]][[match((samples$Name %>% sort())[1], samples[[1]])]],
#   style = 'bootstrap4',
#   filter = 'top',
#   width = '775.25px',
#   fillContainer = TRUE,
#   elementId  = 'target_table'
# )

```

### Partitions

The Partition object represents a partition in a table. It is a child of a Table object and multiple partitions may be combined to form a single table. The partitions in a table define the data from external data sources that become available when the table is queried.

```{r}

partitions <- get_dmv('TMSCHEMA_PARTITIONS')
partition_types <- fromJSON('labels/partition_types.json')
partition_modes <- fromJSON('labels/partition_modes.json')

partitions %<>%
  left_join(
    tables,
    by = c('TableID' = 'ID')
  ) %>%
  left_join(
    partition_types,
    by = c('Type' = 'ID')
  ) %>%
  left_join(
    partition_modes,
    by = c('Mode' = 'ID')
  ) %>%
  filter(
    IsHidden == 'FALSE'
  )

partitions  %>%
  select(
    'Partition name' = Name.x,
    'Table name' = Name.y,
    Description,
    'Type' = 'Type.y',
    'Mode' = 'Type.y.y',
    'Range start' = RangeStart,
    'Range end' = RangeEnd
  ) %>%
  datatable(
    style = 'bootstrap4',
    filter = 'top',
    width = '775.25px'
  )

```

```{r}

table_nodes <- tables[,c("Name", "ID")] %>%
  select(
    'title' = Name,
    'id' = ID) %>%
  mutate(
    'group' = 'Table',
    'shape' = 'box'
  )

partition_nodes <- partitions[,c("Name.x", "ID")] %>%
  select(
    'title' = Name.x,
    'id' = ID) %>%
  mutate(
    'group' = 'Partition',
    'shape' = 'database'
  )

nodes <- rbind(
  partition_nodes,
  table_nodes
)

edges <- data.frame(
  from = partitions$ID,
  to = partitions$TableID,
  length = 500)

visNetwork(nodes = nodes, edges = edges, width = "100%") %>% 
  visOptions(
    highlightNearest = T, 
    nodesIdSelection = T,
    manipulation = F) %>%
  visEdges(arrows = 'to') %>%
  visHierarchicalLayout(direction = "LR")

```

