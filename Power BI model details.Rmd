---
title: "Power BI model details"
author: "Marius Sandu"
date: "11/23/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RDCOMClient)
library(dplyr)
library(magrittr)
library(data.table)
library(jsonlite)

dmv_queries <- fromJSON("dmv.json")

# unlist bad, NULLs can't be inside R vectors
# so it breaks the structure, when using unlist.

get_value <- function(x) {
  get_v1 <- function (x) {
    result <- x[1] # kinda retarded, but works
    return(result) 
  }
  result <- lapply(x, get_v1)
  return(result)
}

rowset_to_DT <- function(x, headers) {
  result <- x %>%
    lapply(get_value) %>%
    as.data.table() %>%
    t() %>%
    as.data.table()
  
  colnames(result) <- headers
  return(result)
}

build_query <- function(view, headers) {
  result <- paste(
    'select',
    paste0('[',headers, ']', collapse = ","),
    paste0('from $system.', view)
  )
  return(result)
}

```


```{r}
# TODO: the port can be scanned from the localappdata folder, and the initial catalogue retrieved via a DMV query
con <- COMCreate("ADODB.Connection")
con[["ConnectionString"]] <- paste(
  "Provider=MSOLAP.8",
  "Integrated Security=SSPI",
  "Persist Security Info=True",
  "Data Source=localhost:55995",
  "Initial Catalog=2cdf3dfa-9439-48d0-b47c-b4ae194743ac",
  sep = ";")

con$Open()
```

## Getting raw tables

```{r echo=FALSE}

# [X] TODO: deserialize the data here from some JSON file.
# [ ] TODO: This still looks kinda wonky

relationships_headers <- dmv_queries[dmv_queries$view == 'TMSCHEMA_RELATIONSHIPS',]$headers[[1]]

relationships <- con$Execute(
    build_query('TMSCHEMA_RELATIONSHIPS', relationships_headers)
  )$GetRows() %>%
    rowset_to_DT(headers = relationships_headers)

tables_headers <- dmv_queries[dmv_queries$view == 'TMSCHEMA_TABLES',]$headers[[1]]

tables <- con$Execute(
    build_query('TMSCHEMA_TABLES', tables_headers)
  )$GetRows() %>%
    rowset_to_DT(headers = tables_headers)

columns_headers <- dmv_queries[dmv_queries$view == 'TMSCHEMA_COLUMNS',]$headers[[1]]

columns <- con$Execute(
    build_query('TMSCHEMA_COLUMNS', columns_headers)
  )$GetRows() %>%
    rowset_to_DT(headers = columns_headers)

measures_headers <- dmv_queries[dmv_queries$view == 'TMSCHEMA_MEASURES',]$headers[[1]]

measures <- con$Execute(
    build_query('TMSCHEMA_MEASURES', measures_headers)
  )$GetRows() %>%
    rowset_to_DT(headers = measures_headers)

```